<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Commerce API Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .product-card { transition: transform 0.2s; cursor: pointer; }
        .product-card:hover { transform: scale(1.02); }
        .product-img { height: 200px; object-fit: cover; }
        .cart-img-preview { width: 50px; height: 50px; object-fit: cover; border-radius: 5px; }
        #main-app, #register-box { display: none; }
    </style>
</head>
<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">REST API E-COMMERCE</a>
            <div class="d-flex">
                <button id="btn-logout" class="btn btn-danger btn-sm d-none" onclick="logout()">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        
        <div id="auth-section" class="row justify-content-center">
            <div class="col-md-4" id="login-box">
                <div class="card shadow">
                    <div class="card-body">
                        <h4 class="card-title text-center mb-4">Login</h4>
                        <div class="mb-3"><label>Email</label><input type="email" id="login-email" class="form-control" placeholder="example@email.com"></div>
                        <div class="mb-3"><label>Password</label><input type="password" id="login-pass" class="form-control" placeholder="********"></div>
                        <button onclick="login()" class="btn btn-primary w-100 mb-2">Sign In</button>
                        <button onclick="toggleAuth('register')" class="btn btn-outline-secondary w-100">Create New Account</button>
                    </div>
                </div>
            </div>
            <div class="col-md-4" id="register-box">
                <div class="card shadow">
                    <div class="card-body">
                        <h4 class="card-title text-center mb-4">Register</h4>
                        <div class="mb-3"><label>Full Name</label><input type="text" id="reg-name" class="form-control"></div>
                        <div class="mb-3"><label>Email</label><input type="email" id="reg-email" class="form-control"></div>
                        <div class="mb-3"><label>Password</label><input type="password" id="reg-pass" class="form-control"></div>
                        <button onclick="register()" class="btn btn-success w-100 mb-2">Register Now</button>
                        <button onclick="toggleAuth('login')" class="btn btn-outline-secondary w-100">Back to Login</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="main-app">
            <div class="alert alert-info d-flex justify-content-between align-items-center">
                <span>Hello, <strong id="user-name">User</strong> (<span id="user-role"></span>)</span>
                <button class="btn btn-sm btn-outline-primary" onclick="loadOrders()">Order History</button>
            </div>

            <div class="row">
                <div id="product-col" class="col-md-8">
                    <div class="d-flex justify-content-between mb-3">
                        <h3>Product List</h3>
                        <button id="btn-add-product" class="btn btn-success btn-sm d-none" onclick="openProductModal()">+ Add Product</button>
                    </div>
                    <div id="product-list" class="row g-3"></div>
                </div>

                <div id="cart-col" class="col-md-4">
                    <div class="card shadow-sm sticky-top" style="top: 20px;">
                        <div class="card-header bg-white fw-bold">Shopping Cart ðŸ›’</div>
                        <div class="card-body">
                            <ul id="cart-list" class="list-group list-group-flush mb-3">
                                <li class="list-group-item text-muted text-center">Empty</li>
                            </ul>
                            <div class="d-flex justify-content-between fw-bold mb-3">
                                <span>Total:</span>
                                <span id="cart-total">$0</span>
                            </div>
                            <button onclick="openCheckoutModal()" class="btn btn-primary w-100" id="btn-checkout" disabled>Checkout</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="orderModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header"><h5 class="modal-title">My Order History</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                    <div class="modal-body" id="order-history-body">Loading...</div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="productModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header"><h5 class="modal-title" id="productModalTitle">Product Details</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                    <div class="modal-body">
                        <input type="hidden" id="p-id">
                        <div class="text-center mb-3">
                            <img id="p-image-preview" src="" class="img-fluid rounded d-none" style="max-height: 200px;">
                        </div>
                        <div class="mb-2"><label>Name</label><input type="text" id="p-name" class="form-control"></div>
                        <div class="mb-2"><label>Description</label><textarea id="p-desc" class="form-control"></textarea></div>
                        <div class="row">
                            <div class="col-6 mb-2"><label>Price</label><input type="number" id="p-price" class="form-control"></div>
                            <div class="col-6 mb-2"><label>Stock</label><input type="number" id="p-stock" class="form-control"></div>
                        </div>
                        <div class="mb-2" id="admin-upload-section">
                            <label>Product Photo</label><input type="file" id="p-image-input" class="form-control" accept="image/*">
                        </div>
                        <div id="user-qty-section" class="mt-3 pt-3 border-top d-none">
                            <label class="fw-bold">Quantity to buy:</label><input type="number" id="p-buy-qty" class="form-control" value="1" min="1">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" id="btn-modal-action" class="btn btn-primary" onclick="handleModalAction()">Save</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="checkoutModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Confirm Your Order</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p class="text-muted">Please review your items before proceeding to payment.</p>
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Product</th>
                                        <th>Price</th>
                                        <th>Qty</th>
                                        <th class="text-end">Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody id="checkout-items-body">
                                    </tbody>
                                <tfoot>
                                    <tr>
                                        <th colspan="3" class="text-end">Grand Total</th>
                                        <th class="text-end fs-5 text-primary" id="checkout-grand-total"></th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-success fw-bold" onclick="processPayment()">Confirm Payment ðŸ’³</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'https://rest-api-ecommerce-ruddy.vercel.app/api';
        const BASE_URL = 'https://rest-api-ecommerce-ruddy.vercel.app';
        
        let cart = [];
        let productModalInstance;
        let checkoutModalInstance;

        const token = localStorage.getItem('token');
        if (token) showApp();

        function toggleAuth(view) {
            document.getElementById('login-box').style.display = view === 'login' ? 'block' : 'none';
            document.getElementById('register-box').style.display = view === 'register' ? 'block' : 'none';
        }
        async function register() {
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-pass').value;
            try {
                const res = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, password })
                });
                if (res.ok) { alert("Registration Success!"); toggleAuth('login'); }
                else { const d = await res.json(); alert(d.error); }
            } catch (err) { alert('Error'); }
        }
        async function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-pass').value;
            try {
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();
                if (res.ok) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    showApp();
                } else { alert(data.error); }
            } catch (err) { console.error(err); }
        }
        function logout() { localStorage.clear(); location.reload(); }

        function showApp() {
            document.getElementById('auth-section').classList.add('d-none');
            document.getElementById('main-app').style.display = 'block';
            document.getElementById('btn-logout').classList.remove('d-none');
            const user = JSON.parse(localStorage.getItem('user'));
            document.getElementById('user-name').innerText = user.name;
            document.getElementById('user-role').innerText = user.role;
            const productCol = document.getElementById('product-col');
            const cartCol = document.getElementById('cart-col');
            if(user.role === 'ADMIN') {
                document.getElementById('btn-add-product').classList.remove('d-none');
                cartCol.style.display = 'none';
                productCol.classList.remove('col-md-8');
                productCol.classList.add('col-12');
            } else {
                document.getElementById('btn-add-product').classList.add('d-none');
                cartCol.style.display = 'block';
                productCol.classList.add('col-md-8');
                productCol.classList.remove('col-12');
            }
            productModalInstance = new bootstrap.Modal(document.getElementById('productModal'));
            checkoutModalInstance = new bootstrap.Modal(document.getElementById('checkoutModal'));
            loadProducts();
        }

        async function loadProducts() {
            try {
                const res = await fetch(`${API_URL}/products`);
                const json = await res.json();
                const products = json.data;
                const listContainer = document.getElementById('product-list');
                const isAdmin = JSON.parse(localStorage.getItem('user')).role === 'ADMIN';
                listContainer.innerHTML = '';
                products.forEach(p => {
                    const imgUrl = p.photo ? `${BASE_URL}${p.photo}` : 'https://placehold.co/400x200?text=No+Photo';
                    const html = `
                        <div class="${isAdmin ? 'col-md-3' : 'col-md-6'}">
                            <div class="card product-card h-100" onclick='openProductModal(${JSON.stringify(p)})'>
                                <img src="${imgUrl}" class="card-img-top product-img" alt="${p.name}">
                                <div class="card-body">
                                    <h5 class="card-title">${p.name}</h5>
                                    <h6 class="text-primary">$${p.price.toLocaleString()}</h6>
                                    <p class="mb-0 small text-muted">Stock: ${p.stock}</p>
                                </div>
                            </div>
                        </div>
                    `;
                    listContainer.innerHTML += html;
                });
            } catch (err) { console.error(err); }
        }

        function openProductModal(product = null) {
            const user = JSON.parse(localStorage.getItem('user'));
            const isAdmin = user.role === 'ADMIN';
            const btnAction = document.getElementById('btn-modal-action');
            const qtySection = document.getElementById('user-qty-section');
            const uploadSection = document.getElementById('admin-upload-section');
            const imgPreview = document.getElementById('p-image-preview');
            const inputs = ['p-name', 'p-desc', 'p-price', 'p-stock'];

            if(product && product.photo) {
                imgPreview.src = `${BASE_URL}${product.photo}`;
                imgPreview.classList.remove('d-none');
            } else { imgPreview.classList.add('d-none'); }

            if (isAdmin) {
                qtySection.classList.add('d-none');
                uploadSection.classList.remove('d-none');
                inputs.forEach(id => document.getElementById(id).disabled = false);
                if (product) {
                    document.getElementById('productModalTitle').innerText = "Edit Product";
                    document.getElementById('p-id').value = product.id;
                    document.getElementById('p-name').value = product.name;
                    document.getElementById('p-desc').value = product.description || '';
                    document.getElementById('p-price').value = product.price;
                    document.getElementById('p-stock').value = product.stock;
                    document.getElementById('p-image-input').value = ''; 
                    btnAction.innerText = "Save Changes";
                    btnAction.onclick = saveProduct;
                    if(!document.getElementById('btn-delete-prod')) {
                         const delBtn = document.createElement('button');
                         delBtn.id = 'btn-delete-prod'; delBtn.className = 'btn btn-danger me-auto'; delBtn.innerText = 'Delete';
                         delBtn.onclick = () => deleteProduct(product.id);
                         document.querySelector('.modal-footer').prepend(delBtn);
                    } else { const delBtn = document.getElementById('btn-delete-prod'); delBtn.onclick = () => deleteProduct(product.id); delBtn.style.display = 'block'; }
                } else {
                    document.getElementById('productModalTitle').innerText = "Add Product";
                    inputs.forEach(id => document.getElementById(id).value = '');
                    document.getElementById('p-id').value = ''; document.getElementById('p-image-input').value = ''; imgPreview.classList.add('d-none');
                    btnAction.innerText = "Create"; btnAction.onclick = saveProduct;
                    if(document.getElementById('btn-delete-prod')) document.getElementById('btn-delete-prod').style.display = 'none';
                }
            } else {
                if(document.getElementById('btn-delete-prod')) document.getElementById('btn-delete-prod').style.display = 'none';
                qtySection.classList.remove('d-none');
                uploadSection.classList.add('d-none');
                inputs.forEach(id => document.getElementById(id).disabled = true);
                document.getElementById('productModalTitle').innerText = "Buy Product";
                document.getElementById('p-id').value = product.id;
                document.getElementById('p-name').value = product.name;
                document.getElementById('p-desc').value = product.description || '';
                document.getElementById('p-price').value = product.price;
                document.getElementById('p-stock').value = product.stock;
                document.getElementById('p-buy-qty').value = 1; document.getElementById('p-buy-qty').max = product.stock;
                if(product.stock < 1) { btnAction.innerText = "Out of Stock"; btnAction.disabled = true; } 
                else { btnAction.innerText = "Add to Cart"; btnAction.disabled = false; btnAction.onclick = () => addToCart(product); }
            }
            productModalInstance.show();
        }

        async function saveProduct() {
            const id = document.getElementById('p-id').value;
            const token = localStorage.getItem('token');
            const fileInput = document.getElementById('p-image-input');
            const formData = new FormData();
            formData.append('name', document.getElementById('p-name').value);
            formData.append('description', document.getElementById('p-desc').value);
            formData.append('price', document.getElementById('p-price').value);
            formData.append('stock', document.getElementById('p-stock').value);
            if (fileInput.files.length > 0) formData.append('image', fileInput.files[0]);
            const url = id ? `${API_URL}/products/${id}` : `${API_URL}/products`;
            const method = id ? 'PUT' : 'POST';
            try {
                const res = await fetch(url, { method: method, headers: { 'Authorization': `Bearer ${token}` }, body: formData });
                if (res.ok) { productModalInstance.hide(); loadProducts(); } else { const d = await res.json(); alert(d.error || "Failed"); }
            } catch(e) { console.error(e); alert("Error"); }
        }

        async function deleteProduct(id) {
            if(!confirm("Delete?")) return;
            const token = localStorage.getItem('token');
            const res = await fetch(`${API_URL}/products/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
            if(res.ok) { productModalInstance.hide(); loadProducts(); } else alert("Failed");
        }

        function addToCart(product) {
            const qty = parseInt(document.getElementById('p-buy-qty').value);
            if(qty > product.stock) { alert("Insufficient stock!"); return; }
            const existing = cart.find(item => item.productId === product.id);
            if (existing) {
                if(existing.quantity + qty > product.stock) { alert("Max stock reached!"); return; }
                existing.quantity += qty;
            } else {
                cart.push({ productId: product.id, name: product.name, price: product.price, quantity: qty, photo: product.photo });
            }
            productModalInstance.hide();
            openCheckoutModal();
        }

        function removeFromCart(index) { cart.splice(index, 1); openCheckoutModal(); }

        function openCheckoutModal() {
            const cartBtn = document.getElementById('btn-checkout');
            const cartTotal = document.getElementById('cart-total');
            let total = 0;
            
            const tbody = document.getElementById('checkout-items-body');
            const grandTotalEl = document.getElementById('checkout-grand-total');
            tbody.innerHTML = '';

            if (cart.length === 0) {
                cartBtn.disabled = true;
                cartTotal.innerText = "$0";
                grandTotalEl.innerText = "$0";
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">Cart is empty</td></tr>';
                return;
            } else {
                cartBtn.disabled = false;
            }

            cart.forEach((item, index) => {
                const subtotal = item.price * item.quantity;
                total += subtotal;
                const imgUrl = item.photo ? `${BASE_URL}${item.photo}` : 'https://placehold.co/50x50?text=img';
                
                tbody.innerHTML += `
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <img src="${imgUrl}" class="cart-img-preview me-2">
                                <span>${item.name}</span>
                            </div>
                        </td>
                        <td>$${item.price.toLocaleString()}</td>
                        <td>${item.quantity}</td>
                        <td class="text-end fw-bold">
                            $${subtotal.toLocaleString()} 
                            <button class="btn btn-sm btn-outline-danger ms-2" onclick="removeFromCart(${index})">x</button>
                        </td>
                    </tr>
                `;
            });

            cartTotal.innerText = "$" + total.toLocaleString();
            grandTotalEl.innerText = "$" + total.toLocaleString();
            
        }
        
        function showCheckout() {
            openCheckoutModal();
            checkoutModalInstance.show();
        }

        document.getElementById('btn-checkout').onclick = showCheckout;


        async function processPayment() {
            const token = localStorage.getItem('token');
            try {
                const res = await fetch(`${API_URL}/orders/checkout`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ items: cart.map(c => ({ productId: c.productId, quantity: c.quantity })) })
                });
                
                if (res.ok) {
                    checkoutModalInstance.hide();
                    alert('Payment Successful! Thank you for your order.');
                    cart = [];
                    openCheckoutModal();
                    loadProducts();
                } else {
                    const data = await res.json();
                    alert(data.error);
                }
            } catch (err) { alert('Transaction Failed'); }
        }

        async function loadOrders() {
            const token = localStorage.getItem('token');
            const modal = new bootstrap.Modal(document.getElementById('orderModal'));
            modal.show();
            const res = await fetch(`${API_URL}/orders/my-orders`, { headers: { 'Authorization': `Bearer ${token}` } });
            const json = await res.json();
            const orders = json.data;
            let html = '';
            if(orders.length === 0) html = '<p class="text-center">No orders.</p>';
            orders.forEach(o => {
                let itemsHtml = o.items.map(i => `<li>${i.product.name} (${i.quantity}x)</li>`).join('');
                html += `<div class="card mb-3"><div class="card-header d-flex justify-content-between"><span>Order #${o.id}</span><span class="badge bg-${o.status === 'CANCELLED' ? 'danger' : 'success'}">${o.status}</span></div><div class="card-body"><ul>${itemsHtml}</ul><p class="fw-bold mb-1">Total: $${o.totalPrice.toLocaleString()}</p>${o.status !== 'CANCELLED' ? `<button onclick="cancelOrder(${o.id})" class="btn btn-sm btn-outline-danger float-end">Cancel</button>` : ''}</div></div>`;
            });
            document.getElementById('order-history-body').innerHTML = html;
        }
        async function cancelOrder(id) { if(!confirm("Cancel?")) return; const token = localStorage.getItem('token'); const res = await fetch(`${API_URL}/orders/${id}/cancel`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } }); if(res.ok) { loadOrders(); loadProducts(); } }
        function handleModalAction() {}
    </script>
</body>
</html>
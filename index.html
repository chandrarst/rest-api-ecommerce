<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Commerce API Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .product-card { transition: transform 0.2s; cursor: pointer; }
        .product-card:hover { transform: scale(1.02); }
        #main-app, #register-box { display: none; }
    </style>
</head>
<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">REST API E-COMMERCE</a>
            <div class="d-flex">
                <button id="btn-logout" class="btn btn-danger btn-sm d-none" onclick="logout()">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        
        <div id="auth-section" class="row justify-content-center">
            
            <div class="col-md-4" id="login-box">
                <div class="card shadow">
                    <div class="card-body">
                        <h4 class="card-title text-center mb-4">Login</h4>
                        <div class="mb-3">
                            <label>Email</label>
                            <input type="email" id="login-email" class="form-control" placeholder="test@gmail.com">
                        </div>
                        <div class="mb-3">
                            <label>Password</label>
                            <input type="password" id="login-pass" class="form-control" placeholder="********">
                        </div>
                        <button onclick="login()" class="btn btn-primary w-100 mb-2">Sign In</button>
                        <button onclick="toggleAuth('register')" class="btn btn-outline-secondary w-100">Create New Account</button>
                    </div>
                </div>
            </div>

            <div class="col-md-4" id="register-box">
                <div class="card shadow">
                    <div class="card-body">
                        <h4 class="card-title text-center mb-4">Register</h4>
                        <div class="mb-3">
                            <label>Full Name</label>
                            <input type="text" id="reg-name" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label>Email</label>
                            <input type="email" id="reg-email" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label>Password</label>
                            <input type="password" id="reg-pass" class="form-control">
                        </div>
                        <button onclick="register()" class="btn btn-success w-100 mb-2">Register Now</button>
                        <button onclick="toggleAuth('login')" class="btn btn-outline-secondary w-100">Already have an account? Login</button>
                    </div>
                </div>
            </div>

        </div>

        <div id="main-app">
            <div class="alert alert-info d-flex justify-content-between align-items-center">
                <span>Hello, <strong id="user-name">User</strong> (<span id="user-role"></span>)</span>
                <button class="btn btn-sm btn-outline-primary" onclick="loadOrders()">Order History</button>
            </div>

            <div class="row">
                <div id="product-col" class="col-md-8">
                    <div class="d-flex justify-content-between mb-3">
                        <h3>Product List</h3>
                        <button id="btn-add-product" class="btn btn-success btn-sm d-none" onclick="openProductModal()">+ Add Product</button>
                    </div>
                    <div id="product-list" class="row g-3"></div>
                </div>

                <div id="cart-col" class="col-md-4">
                    <div class="card shadow-sm sticky-top" style="top: 20px;">
                        <div class="card-header bg-white fw-bold">Shopping Cart ðŸ›’</div>
                        <div class="card-body">
                            <ul id="cart-list" class="list-group list-group-flush mb-3">
                                <li class="list-group-item text-muted text-center">Empty</li>
                            </ul>
                            <div class="d-flex justify-content-between fw-bold mb-3">
                                <span>Total:</span>
                                <span id="cart-total">$0</span>
                            </div>
                            <button onclick="checkout()" class="btn btn-primary w-100" id="btn-checkout" disabled>Checkout</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="orderModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">My Order History</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="order-history-body">Loading...</div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="productModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="productModalTitle">Product Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="p-id">
                        <div class="mb-2">
                            <label>Product Name</label>
                            <input type="text" id="p-name" class="form-control">
                        </div>
                        <div class="mb-2">
                            <label>Description</label>
                            <textarea id="p-desc" class="form-control"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-2">
                                <label>Price</label>
                                <input type="number" id="p-price" class="form-control">
                            </div>
                            <div class="col-6 mb-2">
                                <label>Stock Available</label>
                                <input type="number" id="p-stock" class="form-control">
                            </div>
                        </div>
                        
                        <div id="user-qty-section" class="mt-3 pt-3 border-top d-none">
                            <label class="fw-bold">Quantity to buy:</label>
                            <input type="number" id="p-buy-qty" class="form-control" value="1" min="1">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" id="btn-modal-action" class="btn btn-primary" onclick="handleModalAction()">Save</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'http://localhost:3000/api';
        let cart = [];
        let productModalInstance;

        const token = localStorage.getItem('token');
        if (token) showApp();

        function toggleAuth(view) {
            if(view === 'register') {
                document.getElementById('login-box').style.display = 'none';
                document.getElementById('register-box').style.display = 'block';
            } else {
                document.getElementById('login-box').style.display = 'block';
                document.getElementById('register-box').style.display = 'none';
            }
        }

        async function register() {
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-pass').value;

            try {
                const res = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, password })
                });
                
                if (res.ok) {
                    alert("Registration Successful! Please Login.");
                    toggleAuth('login');
                } else {
                    const data = await res.json();
                    alert(data.error);
                }
            } catch (err) { alert('Connection Error'); }
        }

        async function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-pass').value;

            try {
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();

                if (res.ok) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    showApp();
                } else {
                    alert(data.error);
                }
            } catch (err) { console.error(err); }
        }

        function logout() {
            localStorage.clear();
            location.reload();
        }

        function showApp() {
            document.getElementById('auth-section').classList.add('d-none');
            document.getElementById('main-app').style.display = 'block';
            document.getElementById('btn-logout').classList.remove('d-none');

            const user = JSON.parse(localStorage.getItem('user'));
            document.getElementById('user-name').innerText = user.name;
            document.getElementById('user-role').innerText = user.role;

            const productCol = document.getElementById('product-col');
            const cartCol = document.getElementById('cart-col');

            if(user.role === 'ADMIN') {
                document.getElementById('btn-add-product').classList.remove('d-none');
                cartCol.style.display = 'none';
                productCol.classList.remove('col-md-8');
                productCol.classList.add('col-12');
            } else {
                document.getElementById('btn-add-product').classList.add('d-none');
                cartCol.style.display = 'block';
                productCol.classList.add('col-md-8');
                productCol.classList.remove('col-12');
            }

            productModalInstance = new bootstrap.Modal(document.getElementById('productModal'));
            loadProducts();
        }

        async function loadProducts() {
            try {
                const res = await fetch(`${API_URL}/products`);
                const json = await res.json();
                const products = json.data;
                const listContainer = document.getElementById('product-list');
                const isAdmin = JSON.parse(localStorage.getItem('user')).role === 'ADMIN';

                listContainer.innerHTML = '';

                products.forEach(p => {
                    const html = `
                        <div class="${isAdmin ? 'col-md-3' : 'col-md-6'}">
                            <div class="card product-card h-100" onclick='openProductModal(${JSON.stringify(p)})'>
                                <div class="card-body">
                                    <h5 class="card-title">${p.name}</h5>
                                    <h6 class="text-primary">$${p.price.toLocaleString()}</h6>
                                    <p class="mb-0"><small>Stock: ${p.stock}</small></p>
                                    <div class="text-muted small mt-2 fst-italic">Click for details</div>
                                </div>
                            </div>
                        </div>
                    `;
                    listContainer.innerHTML += html;
                });
            } catch (err) { console.error(err); }
        }

        function openProductModal(product = null) {
            const user = JSON.parse(localStorage.getItem('user'));
            const isAdmin = user.role === 'ADMIN';
            const btnAction = document.getElementById('btn-modal-action');
            const qtySection = document.getElementById('user-qty-section');

            const inputs = ['p-name', 'p-desc', 'p-price', 'p-stock'];

            if (isAdmin) {
                qtySection.classList.add('d-none');
                inputs.forEach(id => document.getElementById(id).disabled = false);
                
                if (product) {
                    document.getElementById('productModalTitle').innerText = "Edit Product";
                    document.getElementById('p-id').value = product.id;
                    document.getElementById('p-name').value = product.name;
                    document.getElementById('p-desc').value = product.description || '';
                    document.getElementById('p-price').value = product.price;
                    document.getElementById('p-stock').value = product.stock;
                    btnAction.innerText = "Save Changes";
                    btnAction.onclick = saveProduct;

                    if(!document.getElementById('btn-delete-prod')) {
                         const delBtn = document.createElement('button');
                         delBtn.id = 'btn-delete-prod';
                         delBtn.className = 'btn btn-danger me-auto';
                         delBtn.innerText = 'Delete Product';
                         delBtn.onclick = () => deleteProduct(product.id);
                         document.querySelector('.modal-footer').prepend(delBtn);
                    } else {
                        const delBtn = document.getElementById('btn-delete-prod');
                        delBtn.onclick = () => deleteProduct(product.id);
                        delBtn.style.display = 'block';
                    }

                } else {
                    document.getElementById('productModalTitle').innerText = "Add New Product";
                    inputs.forEach(id => document.getElementById(id).value = '');
                    document.getElementById('p-id').value = '';
                    btnAction.innerText = "Create Product";
                    btnAction.onclick = saveProduct;
                    if(document.getElementById('btn-delete-prod')) document.getElementById('btn-delete-prod').style.display = 'none';
                }

            } else {
                if(document.getElementById('btn-delete-prod')) document.getElementById('btn-delete-prod').style.display = 'none';
                qtySection.classList.remove('d-none');
                inputs.forEach(id => document.getElementById(id).disabled = true);

                document.getElementById('productModalTitle').innerText = "Buy Product";
                document.getElementById('p-id').value = product.id;
                document.getElementById('p-name').value = product.name;
                document.getElementById('p-desc').value = product.description || 'No description available';
                document.getElementById('p-price').value = product.price;
                document.getElementById('p-stock').value = product.stock;
                document.getElementById('p-buy-qty').value = 1;
                document.getElementById('p-buy-qty').max = product.stock;

                if(product.stock < 1) {
                    btnAction.innerText = "Out of Stock";
                    btnAction.disabled = true;
                } else {
                    btnAction.innerText = "Add to Cart";
                    btnAction.disabled = false;
                    btnAction.onclick = () => addToCart(product);
                }
            }
            productModalInstance.show();
        }

        async function saveProduct() {
            const id = document.getElementById('p-id').value;
            const body = {
                name: document.getElementById('p-name').value,
                description: document.getElementById('p-desc').value,
                price: document.getElementById('p-price').value,
                stock: document.getElementById('p-stock').value
            };
            const token = localStorage.getItem('token');
            const url = id ? `${API_URL}/products/${id}` : `${API_URL}/products`;
            const method = id ? 'PUT' : 'POST';

            const res = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(body)
            });

            if (res.ok) {
                productModalInstance.hide();
                loadProducts();
            } else {
                alert("Failed to save product.");
            }
        }

        async function deleteProduct(id) {
            if(!confirm("Are you sure you want to delete this product?")) return;
            const token = localStorage.getItem('token');
            const res = await fetch(`${API_URL}/products/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if(res.ok) {
                productModalInstance.hide();
                loadProducts();
            } else {
                alert("Failed to delete (Product might have transaction history).");
            }
        }

        function addToCart(product) {
            const qty = parseInt(document.getElementById('p-buy-qty').value);
            if(qty > product.stock) {
                alert("Insufficient stock!");
                return;
            }

            const existing = cart.find(item => item.productId === product.id);
            if (existing) {
                if(existing.quantity + qty > product.stock) {
                    alert("Total quantity exceeds available stock!");
                    return;
                }
                existing.quantity += qty;
            } else {
                cart.push({ 
                    productId: product.id, 
                    name: product.name, 
                    price: product.price, 
                    quantity: qty 
                });
            }
            productModalInstance.hide();
            renderCart();
        }

        function renderCart() {
            const cartContainer = document.getElementById('cart-list');
            const totalContainer = document.getElementById('cart-total');
            const btnCheckout = document.getElementById('btn-checkout');
            cartContainer.innerHTML = '';
            let grandTotal = 0;

            if (cart.length === 0) {
                cartContainer.innerHTML = '<li class="list-group-item text-muted text-center">Empty</li>';
                btnCheckout.disabled = true;
                totalContainer.innerText = "$0";
                return;
            }

            cart.forEach((item, index) => {
                grandTotal += item.price * item.quantity;
                cartContainer.innerHTML += `
                    <li class="list-group-item d-flex justify-content-between lh-sm">
                        <div>
                            <h6 class="my-0">${item.name}</h6>
                            <small class="text-muted">${item.quantity} x $${item.price.toLocaleString()}</small>
                        </div>
                        <button class="btn btn-sm text-danger" onclick="removeFromCart(${index})">x</button>
                    </li>
                `;
            });
            totalContainer.innerText = "$" + grandTotal.toLocaleString();
            btnCheckout.disabled = false;
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            renderCart();
        }

        async function checkout() {
            if(!confirm("Proceed to checkout?")) return;
            const token = localStorage.getItem('token');
            try {
                const res = await fetch(`${API_URL}/orders/checkout`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ items: cart.map(c => ({ productId: c.productId, quantity: c.quantity })) })
                });
                
                if (res.ok) {
                    alert('Transaction Successful!');
                    cart = [];
                    renderCart();
                    loadProducts();
                } else {
                    const data = await res.json();
                    alert(data.error);
                }
            } catch (err) { alert('Checkout Error'); }
        }

        async function loadOrders() {
            const token = localStorage.getItem('token');
            const modal = new bootstrap.Modal(document.getElementById('orderModal'));
            modal.show();

            const res = await fetch(`${API_URL}/orders/my-orders`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const json = await res.json();
            const orders = json.data;
            
            let html = '';
            if(orders.length === 0) html = '<p class="text-center">No order history found.</p>';
            
            orders.forEach(o => {
                let itemsHtml = o.items.map(i => `<li>${i.product.name} (${i.quantity}x)</li>`).join('');
                html += `
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between">
                            <span>Order #${o.id}</span>
                            <span class="badge bg-${o.status === 'CANCELLED' ? 'danger' : 'success'}">${o.status}</span>
                        </div>
                        <div class="card-body">
                            <ul>${itemsHtml}</ul>
                            <p class="fw-bold mb-1">Total: $${o.totalPrice.toLocaleString()}</p>
                            ${o.status !== 'CANCELLED' ? 
                                `<button onclick="cancelOrder(${o.id})" class="btn btn-sm btn-outline-danger float-end">Cancel Order</button>` : ''}
                        </div>
                    </div>
                `;
            });
            document.getElementById('order-history-body').innerHTML = html;
        }

        async function cancelOrder(id) {
            if(!confirm("Are you sure you want to cancel this order?")) return;
            const token = localStorage.getItem('token');
            const res = await fetch(`${API_URL}/orders/${id}/cancel`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if(res.ok) {
                loadOrders();
                loadProducts();
            }
        }

        function handleModalAction() {}
    </script>
</body>
</html>
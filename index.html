<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toko Online API</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .product-card { transition: transform 0.2s; }
        .product-card:hover { transform: scale(1.02); }
        #main-app { display: none; }
    </style>
</head>
<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">ðŸ›’ Toko Online API</a>
            <div class="d-flex">
                <button id="btn-logout" class="btn btn-danger btn-sm d-none" onclick="logout()">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        
        <div id="auth-section" class="row justify-content-center">
            <div class="col-md-4">
                <div class="card shadow">
                    <div class="card-body">
                        <h4 class="card-title text-center mb-4">Login</h4>
                        <div class="mb-3">
                            <label>Email</label>
                            <input type="email" id="login-email" class="form-control" placeholder="test@gmail.com">
                        </div>
                        <div class="mb-3">
                            <label>Password</label>
                            <input type="password" id="login-pass" class="form-control" placeholder="********">
                        </div>
                        <button onclick="login()" class="btn btn-primary w-100">Masuk</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="main-app">
            <div class="alert alert-info d-flex justify-content-between align-items-center">
                <span>Halo, <strong id="user-name">User</strong> (<span id="user-role"></span>)</span>
                <button class="btn btn-sm btn-outline-primary" onclick="loadOrders()">Riwayat Pesanan</button>
            </div>

            <div class="row">
                <div id="product-col" class="col-md-8">
                    <div class="d-flex justify-content-between mb-3">
                        <h3>Daftar Produk</h3>
                        <button id="btn-add-product" class="btn btn-success btn-sm d-none" onclick="openProductModal()">+ Tambah Produk</button>
                    </div>
                    <div id="product-list" class="row g-3"></div>
                </div>

                <div id="cart-col" class="col-md-4">
                    <div class="card shadow-sm sticky-top" style="top: 20px;">
                        <div class="card-header bg-white fw-bold">Keranjang Belanja ðŸ›’</div>
                        <div class="card-body">
                            <ul id="cart-list" class="list-group list-group-flush mb-3">
                                <li class="list-group-item text-muted text-center">Kosong</li>
                            </ul>
                            <div class="d-flex justify-content-between fw-bold mb-3">
                                <span>Total:</span>
                                <span id="cart-total">Rp 0</span>
                            </div>
                            <button onclick="checkout()" class="btn btn-primary w-100" id="btn-checkout" disabled>Checkout</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="orderModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Riwayat Pesanan</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="order-history-body">Loading...</div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="productModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="productModalTitle">Produk</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="p-id">
                        <div class="mb-2">
                            <label>Nama Produk</label>
                            <input type="text" id="p-name" class="form-control">
                        </div>
                        <div class="mb-2">
                            <label>Deskripsi</label>
                            <textarea id="p-desc" class="form-control"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-2">
                                <label>Harga</label>
                                <input type="number" id="p-price" class="form-control">
                            </div>
                            <div class="col-6 mb-2">
                                <label>Stok</label>
                                <input type="number" id="p-stock" class="form-control">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                        <button type="button" class="btn btn-primary" onclick="saveProduct()">Simpan</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'http://localhost:3000/api';
        let cart = [];
        let productModalInstance;

        const token = localStorage.getItem('token');
        if (token) showApp();

        async function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-pass').value;

            try {
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();

                if (res.ok) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    showApp();
                } else {
                    alert(data.error);
                }
            } catch (err) {
                console.error(err);
            }
        }

        function logout() {
            localStorage.clear();
            location.reload();
        }

        function showApp() {
            document.getElementById('auth-section').classList.add('d-none');
            document.getElementById('main-app').style.display = 'block';
            document.getElementById('btn-logout').classList.remove('d-none');

            const user = JSON.parse(localStorage.getItem('user'));
            document.getElementById('user-name').innerText = user.name;
            document.getElementById('user-role').innerText = user.role;

            const productCol = document.getElementById('product-col');
            const cartCol = document.getElementById('cart-col');

            if(user.role === 'ADMIN') {
                document.getElementById('btn-add-product').classList.remove('d-none');
                cartCol.style.display = 'none';
                productCol.classList.remove('col-md-8');
                productCol.classList.add('col-12');
            } else {
                document.getElementById('btn-add-product').classList.add('d-none');
                cartCol.style.display = 'block';
                productCol.classList.add('col-md-8');
                productCol.classList.remove('col-12');
            }

            productModalInstance = new bootstrap.Modal(document.getElementById('productModal'));
            loadProducts();
        }

        async function loadProducts() {
            try {
                const res = await fetch(`${API_URL}/products`);
                const json = await res.json();
                const products = json.data;
                const isAdmin = JSON.parse(localStorage.getItem('user')).role === 'ADMIN';

                const listContainer = document.getElementById('product-list');
                listContainer.innerHTML = '';

                products.forEach(p => {
                    let actionBtn = '';
                    
                    if (isAdmin) {
                        actionBtn = `
                            <div class="d-flex gap-2">
                                <button class="btn btn-warning btn-sm w-50" 
                                    onclick='openProductModal(${JSON.stringify(p)})'>Edit</button>
                                <button class="btn btn-danger btn-sm w-50" 
                                    onclick="deleteProduct(${p.id})">Hapus</button>
                            </div>
                        `;
                    } else {
                        actionBtn = `
                            <button class="btn btn-outline-primary btn-sm w-100" 
                                onclick="addToCart(${p.id}, '${p.name}', ${p.price})"
                                ${p.stock < 1 ? 'disabled' : ''}>
                                ${p.stock < 1 ? 'Habis' : '+ Keranjang'}
                            </button>
                        `;
                    }

                    const html = `
                        <div class="${isAdmin ? 'col-md-3' : 'col-md-6'}">
                            <div class="card product-card h-100">
                                <div class="card-body">
                                    <h5 class="card-title">${p.name}</h5>
                                    <p class="card-text text-muted small">${p.description || '-'}</p>
                                    <h6 class="text-primary">Rp ${p.price.toLocaleString()}</h6>
                                    <p class="mb-2"><small>Stok: ${p.stock}</small></p>
                                    ${actionBtn}
                                </div>
                            </div>
                        </div>
                    `;
                    listContainer.innerHTML += html;
                });
            } catch (err) { console.error(err); }
        }

        function openProductModal(product = null) {
            if (product) {
                document.getElementById('productModalTitle').innerText = "Edit Produk";
                document.getElementById('p-id').value = product.id;
                document.getElementById('p-name').value = product.name;
                document.getElementById('p-desc').value = product.description || '';
                document.getElementById('p-price').value = product.price;
                document.getElementById('p-stock').value = product.stock;
            } else {
                document.getElementById('productModalTitle').innerText = "Tambah Produk";
                document.getElementById('p-id').value = '';
                document.getElementById('p-name').value = '';
                document.getElementById('p-desc').value = '';
                document.getElementById('p-price').value = '';
                document.getElementById('p-stock').value = '';
            }
            productModalInstance.show();
        }

        async function saveProduct() {
            const id = document.getElementById('p-id').value;
            const name = document.getElementById('p-name').value;
            const description = document.getElementById('p-desc').value;
            const price = document.getElementById('p-price').value;
            const stock = document.getElementById('p-stock').value;
            const token = localStorage.getItem('token');

            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API_URL}/products/${id}` : `${API_URL}/products`;

            const res = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ name, description, price, stock })
            });

            if (res.ok) {
                productModalInstance.hide();
                loadProducts();
            } else {
                alert("Gagal menyimpan data");
            }
        }

        async function deleteProduct(id) {
            if(!confirm("Hapus produk?")) return;
            const token = localStorage.getItem('token');
            const res = await fetch(`${API_URL}/products/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if(res.ok) loadProducts();
            else alert("Gagal hapus (Mungkin ada riwayat transaksi)");
        }

        function addToCart(id, name, price) {
            const existing = cart.find(item => item.productId === id);
            if (existing) existing.quantity++;
            else cart.push({ productId: id, name: name, price: price, quantity: 1 });
            renderCart();
        }

        function renderCart() {
            const cartContainer = document.getElementById('cart-list');
            const totalContainer = document.getElementById('cart-total');
            const btnCheckout = document.getElementById('btn-checkout');
            cartContainer.innerHTML = '';
            let grandTotal = 0;

            if (cart.length === 0) {
                cartContainer.innerHTML = '<li class="list-group-item text-muted text-center">Kosong</li>';
                btnCheckout.disabled = true;
                totalContainer.innerText = "Rp 0";
                return;
            }

            cart.forEach((item, index) => {
                grandTotal += item.price * item.quantity;
                cartContainer.innerHTML += `
                    <li class="list-group-item d-flex justify-content-between lh-sm">
                        <div>
                            <h6 class="my-0">${item.name}</h6>
                            <small class="text-muted">${item.quantity} x ${item.price.toLocaleString()}</small>
                        </div>
                        <button class="btn btn-sm text-danger" onclick="removeFromCart(${index})">x</button>
                    </li>
                `;
            });
            totalContainer.innerText = "Rp " + grandTotal.toLocaleString();
            btnCheckout.disabled = false;
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            renderCart();
        }

        async function checkout() {
            if(!confirm("Proses Checkout?")) return;
            const token = localStorage.getItem('token');
            try {
                const res = await fetch(`${API_URL}/orders/checkout`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ items: cart.map(c => ({ productId: c.productId, quantity: c.quantity })) })
                });
                
                if (res.ok) {
                    alert('Sukses!');
                    cart = [];
                    renderCart();
                    loadProducts();
                } else {
                    const data = await res.json();
                    alert(data.error);
                }
            } catch (err) { alert('Error'); }
        }

        async function loadOrders() {
            const token = localStorage.getItem('token');
            const modal = new bootstrap.Modal(document.getElementById('orderModal'));
            modal.show();

            const res = await fetch(`${API_URL}/orders/my-orders`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const json = await res.json();
            const orders = json.data;
            
            let html = '';
            if(orders.length === 0) html = '<p class="text-center">Kosong</p>';
            
            orders.forEach(o => {
                let itemsHtml = o.items.map(i => `<li>${i.product.name} (${i.quantity}x)</li>`).join('');
                html += `
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between">
                            <span>Order #${o.id}</span>
                            <span class="badge bg-${o.status === 'CANCELLED' ? 'danger' : 'success'}">${o.status}</span>
                        </div>
                        <div class="card-body">
                            <ul>${itemsHtml}</ul>
                            <p class="fw-bold mb-1">Total: Rp ${o.totalPrice.toLocaleString()}</p>
                            ${o.status !== 'CANCELLED' ? 
                                `<button onclick="cancelOrder(${o.id})" class="btn btn-sm btn-outline-danger float-end">Batal</button>` : ''}
                        </div>
                    </div>
                `;
            });
            document.getElementById('order-history-body').innerHTML = html;
        }

        async function cancelOrder(id) {
            if(!confirm("Batalkan?")) return;
            const token = localStorage.getItem('token');
            const res = await fetch(`${API_URL}/orders/${id}/cancel`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if(res.ok) {
                loadOrders();
                loadProducts();
            }
        }
    </script>
</body>
</html>